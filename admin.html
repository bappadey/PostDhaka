<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Dhaka | Admin Panel</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        body { background-color: #121A2D; color: white; font-family: sans-serif; padding: 20px; margin: 0; }
        
        /* Layout */
        .main-wrapper { display: flex; gap: 20px; height: 95vh; }
        
        /* Left Side: Controls */
        .controls-container { width: 40%; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; border: 1px solid #333; overflow-y: auto; }
        
        /* Right Side: Live Preview */
        .preview-container { width: 60%; background: #000; border-radius: 10px; border: 1px solid #333; display: flex; flex-direction: column; }
        .preview-header { padding: 10px; background: #222; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center; }
        iframe { width: 100%; height: 100%; border: none; background: #121A2D; }

        h2, h3 { color: #EA1C5C; margin-top: 0; }
        
        /* Form Elements */
        input, select, button { padding: 10px; border-radius: 5px; border: none; font-size: 14px; width: 100%; margin-bottom: 10px; box-sizing: border-box; }
        input, select { background: #222; color: white; border: 1px solid #444; }
        
        .btn-group { display: flex; gap: 5px; }
        .btn-primary { background: #0872B9; color: white; cursor: pointer; font-weight: bold; }
        .btn-primary:hover { background: #065a94; }
        .btn-cancel { background: #555; color: white; cursor: pointer; display: none; }
        .btn-refresh { width: auto; background: #222; color: #fff; border: 1px solid #555; cursor: pointer; }

        /* Draggable List */
        .video-list { margin-top: 20px; }
        .list-item { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #000; padding: 10px; margin-bottom: 8px; border-radius: 4px; 
            border-left: 4px solid #EA1C5C; cursor: grab; transition: background 0.2s;
        }
        .list-item:active { cursor: grabbing; background: #222; }
        .list-item.sortable-ghost { opacity: 0.4; background: #EA1C5C; }
        
        .item-info { flex-grow: 1; margin-left: 10px; }
        .item-info small { color: #888; font-size: 11px; }
        .drag-handle { color: #555; cursor: grab; padding: 5px; }
        
        .actions { display: flex; gap: 5px; }
        .btn-sm { padding: 5px 10px; font-size: 12px; width: auto; cursor: pointer; }
        .edit-btn { background: #f39c12; color: white; }
        .delete-btn { background: #c0392b; color: white; }

        /* Password Section */
        .password-section { margin-top: 20px; border-top: 1px dashed #444; padding-top: 15px; }
    </style>
</head>
<body>

    <div class="main-wrapper">
        <!-- LEFT: Admin Controls -->
        <div class="controls-container">
            <h2 style="text-align:center;">ADMIN PANEL</h2>

            <!-- Login -->
            <div id="login-form">
                <input type="email" id="email" placeholder="Email">
                <input type="password" id="password" placeholder="Password">
                <button class="btn-primary" onclick="login()">Login</button>
            </div>

            <!-- Dashboard -->
            <div id="upload-panel" style="display:none;">
                <h3 id="formTitle">Add Video</h3>
                <input type="hidden" id="editDocId">
                <input type="text" id="ytLink" placeholder="YouTube Link">
                
                <select id="gridSize">
                    <option value="small">Small (1x1)</option>
                    <option value="medium">Medium (2x2)</option>
                    <option value="wide">Wide (3x1)</option>
                    <option value="large">Large (3x2)</option>
                    <option value="tall">Tall (1x3)</option>
                    <option value="sq">Vertical Square (1x2)</option>
                </select>

                <div class="btn-group">
                    <button id="submitBtn" class="btn-primary" onclick="saveVideo()">Upload</button>
                    <button id="cancelBtn" class="btn-cancel" onclick="cancelEdit()">Cancel</button>
                </div>
                
                <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center;">
                    <h3>Sort Videos</h3>
                    <small style="color:#0872B9;">(Drag to Reorder)</small>
                </div>

                <div class="video-list" id="videoListContainer">
                    <!-- List loads here -->
                </div>

                <div class="password-section">
                    <h3>Security</h3>
                    <input type="password" id="newPass" placeholder="New Password">
                    <button onclick="changeAdminPassword()" style="background:#444; color:white;">Change Password</button>
                    <button onclick="logout()" style="background:#c0392b; color:white; margin-top:5px;">Logout</button>
                </div>
            </div>
        </div>

        <!-- RIGHT: Live Preview -->
        <div class="preview-container">
            <div class="preview-header">
                <span>Live Website Preview</span>
                <button class="btn-refresh" onclick="refreshPreview()"><i class="fas fa-sync"></i> Refresh</button>
            </div>
            <iframe id="sitePreview" src="index.html"></iframe>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ======================================================
        // আপনার FIREBASE CONFIG এখানে বসান
        // ======================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBzQ81jG6k6ieD5HShAgubU3fX0eV6x7j8",
            authDomain: "postdhaka-links.firebaseapp.com",
            projectId: "postdhaka-links",
            storageBucket: "postdhaka-links.firebasestorage.app",
            messagingSenderId: "21578530372",
            appId: "1:21578530372:web:ce243a7141d402fb924611",
            measurementId: "G-EZVZ5DSX46"
        };
        // ======================================================

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const colRef = collection(db, "videos");

        // --- AUTH ---
        window.login = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => alert(err.message));
        };
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('upload-panel').style.display = 'flex';
                loadVideos();
            } else {
                document.getElementById('login-form').style.display = 'flex';
                document.getElementById('upload-panel').style.display = 'none';
            }
        });

        // --- HELPER ---
        function getYouTubeID(url) {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // --- SAVE VIDEO ---
        window.saveVideo = async () => {
            const url = document.getElementById('ytLink').value;
            const size = document.getElementById('gridSize').value;
            const editId = document.getElementById('editDocId').value;
            const vidId = getYouTubeID(url);

            if (!vidId) { alert("Invalid URL"); return; }

            try {
                if (editId) {
                    await updateDoc(doc(db, "videos", editId), { id: vidId, cls: size });
                    cancelEdit();
                } else {
                    // Add new video at the end (using Date.now as temp order)
                    await addDoc(colRef, { id: vidId, cls: size, orderIndex: Date.now() });
                    document.getElementById('ytLink').value = "";
                }
                refreshPreview(); // Auto refresh preview
            } catch (e) { alert(e.message); }
        };

        // --- EDIT/DELETE ---
        window.startEdit = (did, yid, sz) => {
            document.getElementById('editDocId').value = did;
            document.getElementById('ytLink').value = `https://youtu.be/${yid}`;
            document.getElementById('gridSize').value = sz;
            document.getElementById('formTitle').innerText = "Edit Video";
            document.getElementById('submitBtn').innerText = "Update";
            document.getElementById('submitBtn').style.background = "#f39c12";
            document.getElementById('cancelBtn').style.display = "block";
        };

        window.cancelEdit = () => {
            document.getElementById('editDocId').value = "";
            document.getElementById('ytLink').value = "";
            document.getElementById('gridSize').value = "small";
            document.getElementById('formTitle').innerText = "Add Video";
            document.getElementById('submitBtn').innerText = "Upload";
            document.getElementById('submitBtn').style.background = "#0872B9";
            document.getElementById('cancelBtn').style.display = "none";
        };

        window.deleteVideo = async (id) => {
            if(confirm("Delete?")) {
                await deleteDoc(doc(db, "videos", id));
                refreshPreview();
            }
        };

        // --- LOAD & SORTABLE LIST ---
        function loadVideos() {
            // Sort by 'orderIndex' to maintain user defined order
            const q = query(colRef, orderBy("orderIndex", "asc"));
            
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('videoListContainer');
                list.innerHTML = "";
                
                snapshot.docs.forEach(doc => {
                    const d = doc.data();
                    const li = document.createElement('div');
                    li.className = "list-item";
                    li.setAttribute('data-id', doc.id); // Store Firestore Doc ID
                    li.innerHTML = `
                        <i class="fas fa-grip-lines drag-handle"></i>
                        <div class="item-info">
                            <strong>${d.cls.toUpperCase()}</strong><br>
                            <small>${d.id}</small>
                        </div>
                        <div class="actions">
                            <button class="btn-sm edit-btn" onclick="startEdit('${doc.id}','${d.id}','${d.cls}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-sm delete-btn" onclick="deleteVideo('${doc.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    list.appendChild(li);
                });

                // Initialize Sortable
                new Sortable(list, {
                    animation: 150,
                    handle: '.drag-handle', // Drag using icon only
                    ghostClass: 'sortable-ghost',
                    onEnd: function (evt) {
                        updateOrderInDB(); // Save new order to Firebase
                    }
                });
            });
        }

        // --- UPDATE ORDER IN FIREBASE ---
        async function updateOrderInDB() {
            const items = document.querySelectorAll('.list-item');
            const batch = writeBatch(db); // Use batch for multiple updates

            items.forEach((item, index) => {
                const docId = item.getAttribute('data-id');
                const docRef = doc(db, "videos", docId);
                // Update 'orderIndex' based on new position
                batch.update(docRef, { orderIndex: index }); 
            });

            await batch.commit();
            console.log("Order updated!");
            refreshPreview();
        }

        // --- LIVE PREVIEW REFRESH ---
        window.refreshPreview = () => {
            const iframe = document.getElementById('sitePreview');
            iframe.src = iframe.src; // Reloads iframe
        };
        
        // Pass changePassword function (same as before)
        window.changeAdminPassword = () => {
             const user = auth.currentUser;
             const p = document.getElementById('newPass').value;
             if(p.length<6) {alert("Min 6 chars"); return;}
             if(user) updatePassword(user, p).then(()=>alert("Updated!")).catch(e=>alert(e.message));
        };

    </script>
</body>
</html>
