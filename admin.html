<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Post Dhaka</title>
    <link rel="icon" href="Assets/Post Dhaka icon.png" type="image/png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --primary: #0872B9; --accent: #EA1C5C; --text: #f1f5f9; --border: #334155; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        /* --- LOGIN SCREEN --- */
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: var(--panel); padding: 40px; border-radius: 12px; width: 350px; text-align: center; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; }
        .login-box h2 { color: var(--primary); margin-bottom: 20px; }
        
        .input-group { position: relative; margin-bottom: 15px; }
        input, textarea { width: 100%; padding: 12px; background: #0f172a; border: 1px solid var(--border); color: white; border-radius: 6px; box-sizing: border-box; outline: none; }
        input:focus { border-color: var(--primary); }
        .toggle-pass { position: absolute; right: 15px; top: 12px; cursor: pointer; color: #64748b; }
        
        .btn-primary { background: var(--primary); color: white; width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; }
        .btn-primary:hover { background: #065a94; }
        
        .forgot-link { display: block; text-align: right; font-size: 12px; color: #94a3b8; margin-bottom: 15px; text-decoration: none; cursor: pointer; }
        .forgot-link:hover { color: var(--accent); }

        /* Forgot Password Section (Hidden by default) */
        #forgot-section { display: none; }
        .back-login { margin-top: 10px; background: transparent; color: #94a3b8; border: none; cursor: pointer; text-decoration: underline; }

        /* --- DASHBOARD --- */
        .dashboard { display: none; height: 100vh; display: flex; }
        .sidebar { width: 260px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .content-area { flex: 1; padding: 30px; overflow-y: auto; display: flex; gap: 20px; }
        
        .nav-btn { background: transparent; color: #94a3b8; padding: 15px 20px; text-align: left; border: none; cursor: pointer; width: 100%; display:block; font-size: 15px; border-left: 3px solid transparent; display: flex; align-items: center; gap: 10px; }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-btn.active { background: rgba(8, 114, 185, 0.1); color: var(--primary); border-left: 3px solid var(--primary); }

        .card { background: var(--panel); padding: 20px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; }
        .video-card { background: #0f172a; border: 1px solid var(--border); padding: 10px; display: flex; gap: 10px; align-items: center; margin-bottom: 8px; cursor: grab; }
        .thumb { width: 80px; height: 45px; object-fit: cover; border-radius: 4px; }
        
        .preview-pane { flex: 1; background: black; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; border: 1px solid var(--border); }
        iframe { width: 100%; height: 100%; border: none; flex: 1; }
        
        /* Utils */
        .hidden { display: none; }
        h3 { margin-top: 0; color: var(--primary); }
    </style>
</head>
<body>

    <!-- 1. LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-box">
            
            <!-- Login Form -->
            <div id="login-form-content">
                <h2><i class="fas fa-lock"></i> Admin Panel</h2>
                <div class="input-group">
                    <input type="email" id="email" placeholder="Email Address">
                </div>
                <div class="input-group">
                    <input type="password" id="password" placeholder="Password">
                    <i class="fas fa-eye toggle-pass" onclick="togglePassword()"></i>
                </div>
                <a class="forgot-link" onclick="toggleForgotInfo()">Forgot Password?</a>
                <button class="btn-primary" onclick="login()" id="loginBtn">Login</button>
            </div>

            <!-- Forgot Password Form -->
            <div id="forgot-section">
                <h2 style="color:var(--accent)"><i class="fas fa-key"></i> Reset Password</h2>
                <p style="font-size:13px; color:#ccc; margin-bottom:15px;">Enter your email to receive a reset link.</p>
                <div class="input-group">
                    <input type="email" id="resetEmail" placeholder="Enter your email">
                </div>
                <button class="btn-primary" onclick="resetPassword()" style="background:var(--accent);">Send Link</button>
                <button class="back-login" onclick="toggleForgotInfo()">Back to Login</button>
            </div>

        </div>
    </div>

    <!-- 2. DASHBOARD -->
    <div class="dashboard" id="dashboard">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div style="padding:20px; font-weight:bold; color:white; font-size: 20px; border-bottom:1px solid var(--border); letter-spacing: 1px;">
                POST <span style="color:var(--accent)">DHAKA</span>
            </div>
            
            <button class="nav-btn active" onclick="switchTab('portfolio')"><i class="fas fa-play-circle"></i> Videos</button>
            <button class="nav-btn" onclick="switchTab('services')"><i class="fas fa-concierge-bell"></i> Services</button>
            <button class="nav-btn" onclick="switchTab('about')"><i class="fas fa-info-circle"></i> About</button>
            <button class="nav-btn" onclick="switchTab('contact')"><i class="fas fa-address-book"></i> Contact</button>
            <button class="nav-btn" onclick="switchTab('settings')"><i class="fas fa-cog"></i> Settings</button>
            
            <div style="margin-top:auto; padding: 20px;">
                 <button onclick="logout()" style="width:100%; background:#ef4444; color:white; padding:10px; border:none; border-radius:6px; cursor:pointer;"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>

        <!-- CONTENT -->
        <div class="content-area">
            
            <!-- PORTFOLIO TAB -->
            <div id="tab-portfolio" class="editor-section" style="display:block; width:450px;">
                <h3>Add Video</h3>
                <div class="card">
                    <label style="color:#aaa; font-size:12px;">YouTube Link</label>
                    <input type="text" id="ytLink" placeholder="Paste YouTube Link Here...">
                    <button class="btn-primary" onclick="saveVideo()">Add to Portfolio</button>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <small style="color:#aaa;">Drag items to reorder</small>
                    <small style="color:var(--accent);" id="vidCount">0 Videos</small>
                </div>
                <div id="videoList"><p style="text-align:center; color:gray;">Loading...</p></div>
            </div>

            <!-- SERVICES TAB -->
            <div id="tab-services" class="editor-section" style="display:none; width:450px;">
                <h3>Manage Services</h3>
                <div id="servicesList">Loading...</div>
            </div>

             <!-- ABOUT TAB -->
             <div id="tab-about" class="editor-section" style="display:none; width:450px;">
                <h3>About Section</h3>
                <div class="card">
                    <label style="color:#aaa; font-size:12px;">Title</label>
                    <input type="text" id="aboutTitle" placeholder="Title">
                    <label style="color:#aaa; font-size:12px;">Description</label>
                    <textarea id="aboutDesc" rows="12" placeholder="Description"></textarea>
                    <button class="btn-primary" onclick="saveAbout()">Save Changes</button>
                </div>
            </div>

             <!-- CONTACT TAB -->
             <div id="tab-contact" class="editor-section" style="display:none; width:450px;">
                <h3>Contact Info</h3>
                <div class="card">
                    <input type="text" id="contactPhone" placeholder="Phone">
                    <input type="text" id="contactEmail" placeholder="Email">
                    <input type="text" id="contactAddr1" placeholder="Address Line 1">
                    <input type="text" id="contactAddr2" placeholder="Address Line 2">
                    <input type="text" id="contactFb" placeholder="Facebook Link">
                    <button class="btn-primary" onclick="saveContact()">Update Info</button>
                </div>
            </div>

            <!-- SETTINGS TAB (CHANGE PASSWORD) -->
            <div id="tab-settings" class="editor-section" style="display:none; width:450px;">
                <h3>Account Settings</h3>
                <div class="card">
                    <h4 style="margin-top:0; color:white;">Change Password</h4>
                    <p style="font-size:12px; color:#aaa;">Enter a new password to update your login credentials.</p>
                    <div class="input-group">
                        <input type="password" id="newPass" placeholder="New Password (min 6 chars)">
                    </div>
                    <div class="input-group">
                        <input type="password" id="confirmPass" placeholder="Confirm New Password">
                    </div>
                    <button class="btn-primary" onclick="changeAdminPassword()" style="background:#f39c12;">Update Password</button>
                </div>
            </div>

            <!-- PREVIEW -->
            <div class="preview-pane">
                <div style="background:var(--panel); padding:10px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:12px; color:gray;">LIVE PREVIEW</span>
                    <button onclick="document.getElementById('sitePreview').src='index.html'" style="background:#334155; color:white; border:none; padding:5px 10px; cursor:pointer; border-radius:4px;"><i class="fas fa-sync"></i> Refresh</button>
                </div>
                <iframe id="sitePreview" src="index.html"></iframe>
            </div>
        </div>
    </div>

    <!-- FIREBASE & JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // Added 'sendPasswordResetEmail' here
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        // PASTE YOUR FIREBASE CONFIG HERE
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBzQ81jG6k6ieD5HShAgubU3fX0eV6x7j8",
            authDomain: "postdhaka-links.firebaseapp.com",
            projectId: "postdhaka-links",
            storageBucket: "postdhaka-links.firebasestorage.app",
            messagingSenderId: "21578530372",
            appId: "1:21578530372:web:ce243a7141d402fb924611",
            measurementId: "G-EZVZ5DSX46"
        };
        // ==========================================

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UI UTILS ---
        window.togglePassword = () => {
            const pass = document.getElementById("password");
            pass.type = pass.type === "password" ? "text" : "password";
        };

        window.toggleForgotInfo = () => {
            const loginForm = document.getElementById('login-form-content');
            const forgotForm = document.getElementById('forgot-section');
            if (loginForm.style.display === 'none') {
                loginForm.style.display = 'block';
                forgotForm.style.display = 'none';
            } else {
                loginForm.style.display = 'none';
                forgotForm.style.display = 'block';
            }
        };

        window.switchTab = (id) => {
            ['portfolio','services','about','contact','settings'].forEach(t => document.getElementById('tab-'+t).style.display = 'none');
            document.getElementById('tab-'+id).style.display = 'block';
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };

        // --- AUTH LOGIC ---
        
        // 1. Login
        window.login = () => {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const btn = document.getElementById('loginBtn');
            btn.innerText = "Checking...";
            
            signInWithEmailAndPassword(auth, email, password)
            .catch((error) => {
                btn.innerText = "Login";
                alert("Login Failed: " + error.message);
            });
        };

        // 2. Forgot Password (Reset)
        window.resetPassword = () => {
            const email = document.getElementById('resetEmail').value.trim();
            if(!email) { alert("Please enter your email."); return; }
            
            sendPasswordResetEmail(auth, email)
            .then(() => {
                alert("Password reset link sent to " + email);
                window.toggleForgotInfo(); // Back to login
            })
            .catch((error) => {
                alert("Error: " + error.message);
            });
        };

        // 3. Change Password (Logged In)
        window.changeAdminPassword = () => {
            const user = auth.currentUser;
            const newPass = document.getElementById('newPass').value;
            const confirmPass = document.getElementById('confirmPass').value;

            if(newPass.length < 6) { alert("Password must be at least 6 characters."); return; }
            if(newPass !== confirmPass) { alert("Passwords do not match!"); return; }

            if(user) {
                updatePassword(user, newPass)
                .then(() => {
                    alert("Password Updated Successfully!");
                    document.getElementById('newPass').value = "";
                    document.getElementById('confirmPass').value = "";
                })
                .catch((error) => {
                    alert("Error: " + error.message);
                    // For security, Firebase requires recent login for password changes
                    if(error.code === 'auth/requires-recent-login') {
                        alert("For security, please logout and login again to change your password.");
                    }
                });
            }
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, u => {
            if(u) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'flex';
                loadAllData();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('loginBtn').innerText = "Login";
            }
        });

        function loadAllData() { loadVideos(); loadServices(); loadAbout(); loadContact(); }

        // --- VIDEO LOGIC (Same as before) ---
        function getYouTubeID(url) {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        window.saveVideo = async () => {
            const url = document.getElementById('ytLink').value;
            const vidId = getYouTubeID(url);
            if(!vidId) return alert("Invalid URL");
            await addDoc(collection(db, "videos"), { id: vidId, cls: 'auto', orderIndex: Date.now() });
            document.getElementById('ytLink').value = "";
            document.getElementById('sitePreview').src='index.html';
        };

        window.deleteVideo = async (id) => {
            if(confirm("Delete?")) await deleteDoc(doc(db, "videos", id));
            document.getElementById('sitePreview').src='index.html';
        };

        function loadVideos() {
            onSnapshot(query(collection(db, "videos"), orderBy("orderIndex", "asc")), snap => {
                const list = document.getElementById('videoList');
                document.getElementById('vidCount').innerText = snap.docs.length + " Videos";
                list.innerHTML = "";
                snap.forEach(d => {
                    const data = d.data();
                    list.innerHTML += `
                    <div class="video-card" data-id="${d.id}">
                        <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
                        <img class="thumb" src="https://img.youtube.com/vi/${data.id}/default.jpg">
                        <div style="flex:1; margin-left:10px;">
                            <span style="font-weight:bold; font-size:13px;">${data.id}</span>
                        </div>
                        <button onclick="deleteVideo('${d.id}')" style="background:#ef4444; color:white; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
                new Sortable(list, { handle: '.drag-handle', onEnd: updateOrder });
            });
        }

        async function updateOrder() {
            const batch = writeBatch(db);
            document.querySelectorAll('.video-card').forEach((el, idx) => {
                batch.update(doc(db, "videos", el.getAttribute('data-id')), { orderIndex: idx });
            });
            await batch.commit();
            document.getElementById('sitePreview').src='index.html';
        }

        // --- SERVICES, ABOUT, CONTACT (Same logic, kept for functionality) ---
        function loadServices() {
            onSnapshot(query(collection(db, "content_services"), orderBy("order", "asc")), snap => {
                const div = document.getElementById('servicesList'); div.innerHTML = "";
                if(snap.empty) createDefaultServices();
                snap.forEach(d => {
                    const s = d.data();
                    div.innerHTML += `<div class="card">
                        <label>Title</label><input value="${s.title}" id="st-${d.id}">
                        <label>Desc</label><textarea rows="2" id="sd-${d.id}">${s.description}</textarea>
                        <label>Src</label><input value="${s.src}" id="ss-${d.id}">
                        <button class="btn-primary" onclick="updSvc('${d.id}')" style="margin-top:5px;">Update</button>
                    </div>`;
                });
            });
        }
        async function createDefaultServices() { /* ...defaults... */ }
        window.updSvc = async(id) => {
            await updateDoc(doc(db, "content_services", id), {
                title: document.getElementById('st-'+id).value,
                description: document.getElementById('sd-'+id).value,
                src: document.getElementById('ss-'+id).value
            });
            document.getElementById('sitePreview').src='index.html';
        }

        async function loadAbout() {
            const s = await getDoc(doc(db, "site_content", "about"));
            if(s.exists()) {
                document.getElementById('aboutTitle').value = s.data().title;
                document.getElementById('aboutDesc').value = s.data().description;
            }
        }
        window.saveAbout = async() => {
            await setDoc(doc(db, "site_content", "about"), { title: document.getElementById('aboutTitle').value, description: document.getElementById('aboutDesc').value });
            document.getElementById('sitePreview').src='index.html';
        }

        async function loadContact() {
            const s = await getDoc(doc(db, "site_content", "contact"));
            if(s.exists()) {
                const d = s.data();
                document.getElementById('contactPhone').value = d.phone;
                document.getElementById('contactEmail').value = d.email;
                document.getElementById('contactAddr1').value = d.addr1;
                document.getElementById('contactAddr2').value = d.addr2;
                document.getElementById('contactFb').value = d.fb;
            }
        }
        window.saveContact = async() => {
            await setDoc(doc(db, "site_content", "contact"), {
                phone: document.getElementById('contactPhone').value,
                email: document.getElementById('contactEmail').value,
                addr1: document.getElementById('contactAddr1').value,
                addr2: document.getElementById('contactAddr2').value,
                fb: document.getElementById('contactFb').value
            });
            document.getElementById('sitePreview').src='index.html';
        }
    </script>
</body>
</html>
