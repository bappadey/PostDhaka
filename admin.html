<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Dhaka | Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #121A2D; color: white; font-family: sans-serif; display: flex; justify-content: center; padding: 50px; }
        .container { width: 700px; background: rgba(255,255,255,0.05); padding: 30px; border-radius: 10px; border: 1px solid #333; }
        h2 { text-align: center; color: #EA1C5C; margin-bottom: 20px; }
        
        /* Login Form */
        #login-form { display: flex; flex-direction: column; gap: 10px; }
        
        /* Upload/Edit Form */
        #upload-panel { display: none; flex-direction: column; gap: 15px; }
        
        input, select, button { padding: 12px; border-radius: 5px; border: none; font-size: 16px; }
        input { background: #222; color: white; border: 1px solid #444; }
        
        /* Buttons */
        .btn-primary { background: #0872B9; color: white; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary:hover { background: #065a94; }
        
        .btn-cancel { background: #555; color: white; cursor: pointer; font-weight: bold; display: none; }
        .btn-cancel:hover { background: #777; }

        .btn-logout { background: #333; margin-top:20px; width: 100%; color: #aaa; cursor: pointer; }
        .btn-logout:hover { background: #444; color: white; }

        /* List Styling */
        .video-list { margin-top: 30px; border-top: 1px solid #444; padding-top: 20px; }
        .list-item { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #000; padding: 15px; margin-bottom: 10px; border-radius: 4px; border-left: 4px solid #EA1C5C;
        }
        .item-info { flex-grow: 1; }
        .item-info a { color: #0872B9; text-decoration: none; font-size: 12px; }
        .item-actions { display: flex; gap: 10px; }
        
        .edit-btn { background: #f39c12; color: white; padding: 5px 15px; font-size: 14px; cursor: pointer; }
        .delete-btn { background: #c0392b; color: white; padding: 5px 15px; font-size: 14px; cursor: pointer; }

        /* Password Change Section */
        .password-section { margin-top: 40px; border-top: 2px dashed #444; padding-top: 20px; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 5px;}
        .password-section h3 { color: #EA1C5C; margin-top: 0; }
        .pass-inputs { display: flex; gap: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <h2>ADMIN DASHBOARD</h2>

        <!-- Login Section -->
        <div id="login-form">
            <input type="email" id="email" placeholder="Admin Email">
            <input type="password" id="password" placeholder="Password">
            <button class="btn-primary" onclick="login()">Login</button>
        </div>

        <!-- Dashboard Section -->
        <div id="upload-panel">
            <h3 id="formTitle">Add New Video</h3>
            
            <!-- Hidden field to store ID when editing -->
            <input type="hidden" id="editDocId">

            <input type="text" id="ytLink" placeholder="Paste YouTube Full Link (e.g. https://www.youtube.com/watch?v=...)">
            
            <select id="gridSize">
                <option value="small">Small (1x1)</option>
                <option value="medium">Medium (2x2)</option>
                <option value="wide">Wide (3x1)</option>
                <option value="large">Large (3x2)</option>
                <option value="tall">Tall (1x3)</option>
                <option value="sq">Vertical Square (1x2)</option>
            </select>

            <div style="display: flex; gap: 10px;">
                <button id="submitBtn" class="btn-primary" style="flex: 1;" onclick="saveVideo()">Upload Video</button>
                <button id="cancelBtn" class="btn-cancel" style="flex: 1;" onclick="cancelEdit()">Cancel Edit</button>
            </div>

            <div class="video-list" id="videoListContainer">
                <!-- Video List will appear here -->
            </div>

            <!-- Change Password Section -->
            <div class="password-section">
                <h3>Change Password</h3>
                <div class="pass-inputs">
                    <input type="password" id="newPass" placeholder="New Password (min 6 chars)" style="width: 100%;">
                </div>
                <button onclick="changeAdminPassword()" style="background: #555; color:white; cursor:pointer;">Update Password</button>
            </div>
            
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // Added updateDoc for editing feature
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ======================================================
        // YOUR FIREBASE CONFIG
        // ======================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBzQ81jG6k6ieD5HShAgubU3fX0eV6x7j8",
            authDomain: "postdhaka-links.firebaseapp.com",
            projectId: "postdhaka-links",
            storageBucket: "postdhaka-links.firebasestorage.app",
            messagingSenderId: "21578530372",
            appId: "1:21578530372:web:ce243a7141d402fb924611",
            measurementId: "G-EZVZ5DSX46"
        };
        // ======================================================

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const colRef = collection(db, "videos");

        // --- AUTHENTICATION ---
        window.login = () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, email, pass)
                .catch(err => alert("Error: " + err.message));
        };

        window.logout = () => signOut(auth);

        window.changeAdminPassword = () => {
            const user = auth.currentUser;
            const newPass = document.getElementById('newPass').value;
            if (newPass.length < 6) { alert("Password min 6 chars."); return; }
            if (user) {
                updatePassword(user, newPass)
                    .then(() => { alert("Password updated!"); document.getElementById('newPass').value = ""; })
                    .catch((e) => alert("Error: " + e.message));
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('upload-panel').style.display = 'flex';
                loadVideos();
            } else {
                document.getElementById('login-form').style.display = 'flex';
                document.getElementById('upload-panel').style.display = 'none';
            }
        });

        // --- HELPER: Extract ID ---
        function getYouTubeID(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // --- SAVE VIDEO (Add or Update) ---
        window.saveVideo = async () => {
            const url = document.getElementById('ytLink').value;
            const size = document.getElementById('gridSize').value;
            const editId = document.getElementById('editDocId').value; // Check if editing

            const videoId = getYouTubeID(url);
            if (!videoId) { alert("Invalid YouTube Link!"); return; }

            try {
                if (editId) {
                    // Update Existing Video
                    const docRef = doc(db, "videos", editId);
                    await updateDoc(docRef, {
                        id: videoId,
                        cls: size
                    });
                    alert("Video Updated Successfully!");
                    cancelEdit(); // Reset form
                } else {
                    // Add New Video
                    await addDoc(colRef, {
                        id: videoId,
                        cls: size,
                        timestamp: Date.now()
                    });
                    alert("Video Added Successfully!");
                    document.getElementById('ytLink').value = "";
                }
            } catch (e) {
                alert("Error: " + e.message);
            }
        };

        // --- START EDITING ---
        window.startEdit = (docId, currentYtId, currentSize) => {
            // Fill form with existing data
            document.getElementById('editDocId').value = docId;
            document.getElementById('ytLink').value = `https://www.youtube.com/watch?v=${currentYtId}`;
            document.getElementById('gridSize').value = currentSize;

            // Change UI to Edit Mode
            document.getElementById('formTitle').innerText = "Edit Video";
            document.getElementById('submitBtn').innerText = "Update Video";
            document.getElementById('submitBtn').style.background = "#f39c12"; // Orange for update
            document.getElementById('cancelBtn').style.display = "block";
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // --- CANCEL EDIT ---
        window.cancelEdit = () => {
            document.getElementById('editDocId').value = "";
            document.getElementById('ytLink').value = "";
            document.getElementById('gridSize').value = "small";

            // Reset UI
            document.getElementById('formTitle').innerText = "Add New Video";
            document.getElementById('submitBtn').innerText = "Upload Video";
            document.getElementById('submitBtn').style.background = "#0872B9"; // Back to Blue
            document.getElementById('cancelBtn').style.display = "none";
        };

        // --- DELETE VIDEO ---
        window.deleteVideo = async (docId) => {
            if(confirm("Are you sure you want to delete this video?")) {
                await deleteDoc(doc(db, "videos", docId));
            }
        }

        // --- LOAD VIDEOS ---
        function loadVideos() {
            const q = query(colRef, orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('videoListContainer');
                list.innerHTML = "<h4>Video List (Newest First):</h4>";
                
                snapshot.docs.forEach(doc => {
                    const vid = doc.data();
                    list.innerHTML += `
                        <div class="list-item">
                            <div class="item-info">
                                <strong>${vid.cls.toUpperCase()}</strong><br>
                                <a href="https://youtu.be/${vid.id}" target="_blank">https://youtu.be/${vid.id}</a>
                            </div>
                            <div class="item-actions">
                                <button class="edit-btn" onclick="startEdit('${doc.id}', '${vid.id}', '${vid.cls}')">Edit</button>
                                <button class="delete-btn" onclick="deleteVideo('${doc.id}')">Delete</button>
                            </div>
                        </div>
                    `;
                });
            });
        }
    </script>
</body>
</html>
