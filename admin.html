<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Post Dhaka</title>
    <link rel="icon" href="Assets/Post Dhaka icon.png" type="image/png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --primary: #0872B9; --accent: #EA1C5C; --text: #f1f5f9; --border: #334155; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        
        /* LOGIN */
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: var(--panel); padding: 40px; border-radius: 12px; width: 350px; text-align: center; border: 1px solid var(--border); }
        input, textarea { width: 100%; padding: 12px; background: #0f172a; border: 1px solid var(--border); color: white; border-radius: 6px; box-sizing: border-box; outline: none; margin-bottom: 10px; }
        input:focus, textarea:focus { border-color: var(--primary); }
        .btn-primary { background: var(--primary); color: white; width: 100%; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        /* DASHBOARD */
        .dashboard { display: none; height: 100vh; display: flex; }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; background: rgba(0,0,0,0.2); font-weight: bold; color: var(--accent); letter-spacing: 1px; }
        
        .nav-btn { background: transparent; color: #94a3b8; padding: 15px 20px; text-align: left; border: none; cursor: pointer; width: 100%; font-size: 14px; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-btn.active { background: var(--primary); color: white; }
        
        /* CONTENT AREA */
        .content-area { flex: 1; padding: 30px; overflow-y: auto; display: flex; gap: 20px; }
        .editor-section { flex: 1; max-width: 600px; display: none; flex-direction: column; }
        .editor-section.active { display: flex; }
        
        /* CARDS & FORMS */
        .card { background: var(--panel); padding: 20px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; }
        h3 { color: var(--primary); margin-top: 0; }
        label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 5px; }

        /* VIDEO LIST STYLES */
        .video-card { background: #0f172a; border: 1px solid var(--border); padding: 10px; display: flex; gap: 10px; align-items: center; margin-bottom: 8px; cursor: grab; transition: 0.2s; }
        .video-card:hover { border-color: var(--primary); }
        .thumb { width: 60px; height: 34px; object-fit: cover; border-radius: 4px; }
        .drag-handle { cursor: grab; color: #666; padding: 5px; }

        /* PREVIEW */
        .preview-pane { flex: 1; background: black; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); display: flex; flex-direction: column; }
        iframe { width: 100%; height: 100%; border: none; flex: 1; }
        .refresh-btn { background: #334155; color: white; border: none; padding: 5px 10px; cursor: pointer; width: 100%; }
        
        /* SERVICES LIST */
        .service-item { background: #0f172a; padding: 15px; margin-bottom: 10px; border-radius: 6px; border: 1px solid var(--border); }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-box">
            <h2>Admin Panel</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button class="btn-primary" onclick="login()">Login</button>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div class="dashboard" id="dashboard">
        
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">POST DHAKA</div>
            
            <button class="nav-btn active" onclick="switchTab('portfolio')"><i class="fas fa-video"></i> Video Portfolio</button>
            <button class="nav-btn" onclick="switchTab('services')"><i class="fas fa-layer-group"></i> Services</button>
            <button class="nav-btn" onclick="switchTab('about')"><i class="fas fa-info-circle"></i> About Us</button>
            <button class="nav-btn" onclick="switchTab('contact')"><i class="fas fa-address-book"></i> Contact Info</button>
            
            <div style="margin-top: auto; padding: 20px;">
                <button onclick="logout()" style="background: #ef4444; color: white; width: 100%; padding: 8px; border:none; border-radius:4px; cursor:pointer;">Logout</button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="content-area">
            
            <!-- 1. PORTFOLIO TAB -->
            <div id="tab-portfolio" class="editor-section active">
                <h3>Manage Videos</h3>
                <div class="card">
                    <label>Add New Video (YouTube Link)</label>
                    <input type="text" id="ytLink" placeholder="https://youtube.com/watch?v=...">
                    <div style="display:flex; gap:10px;">
                        <select id="gridSize" style="background:#0f172a; color:white; padding:10px; border:1px solid #334155; border-radius:6px; flex:1;">
                            <option value="small">Small (1x1)</option>
                            <option value="medium">Medium (2x2)</option>
                            <option value="wide">Wide (3x1)</option>
                            <option value="large">Large (3x2)</option>
                            <option value="tall">Tall (1x3)</option>
                            <option value="sq">Vertical Square (1x2)</option>
                        </select>
                        <button class="btn-primary" style="width:auto;" onclick="saveVideo()">Add</button>
                    </div>
                </div>
                
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <small style="color:#94a3b8;">Drag to reorder videos</small>
                    <small id="video-count" style="color:#EA1C5C;">Loading...</small>
                </div>
                
                <div id="videoList">
                    <p style="color:gray; text-align:center;">Fetching Data...</p>
                </div>
            </div>

            <!-- 2. SERVICES TAB -->
            <div id="tab-services" class="editor-section">
                <h3>Manage Services</h3>
                <div id="servicesList">Loading services...</div>
            </div>

            <!-- 3. ABOUT TAB -->
            <div id="tab-about" class="editor-section">
                <h3>Edit About Section</h3>
                <div class="card">
                    <label>Title</label>
                    <input type="text" id="aboutTitle">
                    <label>Description (HTML allowed)</label>
                    <textarea id="aboutDesc" rows="10"></textarea>
                    <button class="btn-primary" onclick="saveAbout()">Save Changes</button>
                </div>
            </div>

            <!-- 4. CONTACT TAB -->
            <div id="tab-contact" class="editor-section">
                <h3>Contact Information</h3>
                <div class="card">
                    <label>Phone Number</label>
                    <input type="text" id="contactPhone">
                    <label>Email Address</label>
                    <input type="text" id="contactEmail">
                    <label>Address Line 1</label>
                    <input type="text" id="contactAddr1">
                    <label>Address Line 2</label>
                    <input type="text" id="contactAddr2">
                    <label>Facebook Link</label>
                    <input type="text" id="contactFb">
                    <button class="btn-primary" onclick="saveContact()">Update Contact</button>
                </div>
            </div>

            <!-- PREVIEW PANE -->
            <div class="preview-pane">
                <button class="refresh-btn" onclick="document.getElementById('sitePreview').src='index.html'"><i class="fas fa-sync"></i> Refresh Preview</button>
                <iframe id="sitePreview" src="index.html"></iframe>
            </div>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, getDocs, onSnapshot, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBzQ81jG6k6ieD5HShAgubU3fX0eV6x7j8",
            authDomain: "postdhaka-links.firebaseapp.com",
            projectId: "postdhaka-links",
            storageBucket: "postdhaka-links.firebasestorage.app",
            messagingSenderId: "21578530372",
            appId: "1:21578530372:web:ce243a7141d402fb924611",
            measurementId: "G-EZVZ5DSX46"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- TABS LOGIC ---
        window.switchTab = (tabId) => {
            document.querySelectorAll('.editor-section').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };

        // --- AUTH ---
        window.login = () => {
            signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value)
            .catch(e => alert(e.message));
        };
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, user => {
            if(user) {
                document.getElementById('login-screen').style.display='none';
                document.getElementById('dashboard').style.display='flex';
                loadAllData();
            } else {
                document.getElementById('login-screen').style.display='flex';
                document.getElementById('dashboard').style.display='none';
            }
        });

        function loadAllData() {
            loadVideos();
            loadServices();
            loadAbout();
            loadContact();
        }

        // --- 1. VIDEO LOGIC (WITH AUTO FIX) ---
        function getYouTubeID(url) {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        window.saveVideo = async () => {
            const url = document.getElementById('ytLink').value;
            const size = document.getElementById('gridSize').value;
            const vidId = getYouTubeID(url);
            if(!vidId) return alert("Invalid URL");
            
            // Add with current timestamp as orderIndex initially
            await addDoc(collection(db, "videos"), { id: vidId, cls: size, orderIndex: Date.now() });
            document.getElementById('ytLink').value = "";
            refreshIframe();
        };

        window.deleteVideo = async (id) => {
            if(confirm("Delete?")) await deleteDoc(doc(db, "videos", id));
            refreshIframe();
        };

        async function loadVideos() {
            const list = document.getElementById('videoList');
            
            // NOTE: We are NOT using orderBy in the query here to ensure we fetch ALL docs (even old ones)
            // Then we sort in JS and fix missing indexes.
            onSnapshot(collection(db, "videos"), async (snap) => {
                let videos = [];
                snap.forEach(d => {
                    let v = d.data();
                    v.docId = d.id;
                    videos.push(v);
                });

                // Client-side Sort
                videos.sort((a, b) => {
                    let orderA = a.orderIndex !== undefined ? a.orderIndex : a.timestamp || 0;
                    let orderB = b.orderIndex !== undefined ? b.orderIndex : b.timestamp || 0;
                    return orderA - orderB;
                });

                // AUTO-FIX: Assign orderIndex if missing
                let needsFix = false;
                const batch = writeBatch(db);
                
                videos.forEach((v, idx) => {
                    if (v.orderIndex === undefined) {
                        batch.update(doc(db, "videos", v.docId), { orderIndex: idx });
                        needsFix = true;
                    }
                });
                
                if (needsFix) {
                    await batch.commit();
                    console.log("Old data fixed automatically.");
                }

                // Render List
                document.getElementById('video-count').innerText = videos.length + " Videos";
                list.innerHTML = "";
                
                videos.forEach(v => {
                    list.innerHTML += `
                    <div class="video-card" data-id="${v.docId}">
                        <div class="drag-handle"><i class="fas fa-bars"></i></div>
                        <img class="thumb" src="https://img.youtube.com/vi/${v.id}/default.jpg">
                        <div style="flex:1"><b>${v.cls.toUpperCase()}</b><br><small>${v.id}</small></div>
                        <button onclick="deleteVideo('${v.docId}')" style="background:#ef4444; color:white; border:none; padding:5px; border-radius:4px;"><i class="fas fa-trash"></i></button>
                    </div>`;
                });

                // Init Drag & Drop
                new Sortable(list, { handle: '.drag-handle', onEnd: updateVideoOrder });
            });
        }

        async function updateVideoOrder() {
            const batch = writeBatch(db);
            document.querySelectorAll('.video-card').forEach((el, idx) => {
                batch.update(doc(db, "videos", el.getAttribute('data-id')), { orderIndex: idx });
            });
            await batch.commit();
            refreshIframe();
        }

        // --- 2. SERVICES LOGIC ---
        function loadServices() {
            onSnapshot(query(collection(db, "content_services"), orderBy("order", "asc")), snap => {
                const div = document.getElementById('servicesList');
                div.innerHTML = "";
                if(snap.empty) createDefaultServices();
                
                snap.forEach(d => {
                    const s = d.data();
                    div.innerHTML += `
                    <div class="service-item card">
                        <label>Title</label>
                        <input type="text" id="svc-title-${d.id}" value="${s.title}">
                        <label>Description</label>
                        <textarea id="svc-desc-${d.id}" rows="3">${s.description}</textarea>
                        <label>Media Type</label>
                        <select id="svc-type-${d.id}" style="background:#222; color:white; width:100%; margin-bottom:10px;">
                            <option value="video" ${s.type==='video'?'selected':''}>Video</option>
                            <option value="image" ${s.type==='image'?'selected':''}>Image</option>
                        </select>
                        <label>Source (Path or URL)</label>
                        <input type="text" id="svc-src-${d.id}" value="${s.src}">
                        <button class="btn-primary" onclick="updateService('${d.id}')">Update Service</button>
                    </div>`;
                });
            });
        }

        async function createDefaultServices() {
            const defaults = [
                {title: "Creative Editing", description: "Narratives that captivate...", type: "video", src: "Assets/Service/Edit.jpeg", order: 1},
                {title: "Color Grading", description: "Enhancing visual mood...", type: "video", src: "Assets/Service/Color.webp", order: 2},
                {title: "Online & Finishing", description: "The final touch...", type: "video", src: "Assets/Service/Online.jpeg", order: 3}
            ];
            defaults.forEach(async (s) => await addDoc(collection(db, "content_services"), s));
        }

        window.updateService = async (id) => {
            await updateDoc(doc(db, "content_services", id), {
                title: document.getElementById(`svc-title-${id}`).value,
                description: document.getElementById(`svc-desc-${id}`).value,
                type: document.getElementById(`svc-type-${id}`).value,
                src: document.getElementById(`svc-src-${id}`).value
            });
            alert("Service Updated!");
            refreshIframe();
        }

        // --- 3. ABOUT LOGIC ---
        async function loadAbout() {
            const snap = await getDoc(doc(db, "site_content", "about"));
            if(snap.exists()) {
                document.getElementById('aboutTitle').value = snap.data().title;
                document.getElementById('aboutDesc').value = snap.data().description;
            }
        }
        window.saveAbout = async () => {
            await setDoc(doc(db, "site_content", "about"), {
                title: document.getElementById('aboutTitle').value,
                description: document.getElementById('aboutDesc').value
            });
            alert("About Saved!");
            refreshIframe();
        }

        // --- 4. CONTACT LOGIC ---
        async function loadContact() {
            const snap = await getDoc(doc(db, "site_content", "contact"));
            if(snap.exists()) {
                const d = snap.data();
                document.getElementById('contactPhone').value = d.phone;
                document.getElementById('contactEmail').value = d.email;
                document.getElementById('contactAddr1').value = d.addr1;
                document.getElementById('contactAddr2').value = d.addr2;
                document.getElementById('contactFb').value = d.fb;
            }
        }
        window.saveContact = async () => {
            await setDoc(doc(db, "site_content", "contact"), {
                phone: document.getElementById('contactPhone').value,
                email: document.getElementById('contactEmail').value,
                addr1: document.getElementById('contactAddr1').value,
                addr2: document.getElementById('contactAddr2').value,
                fb: document.getElementById('contactFb').value
            });
            alert("Contact Saved!");
            refreshIframe();
        }

        function refreshIframe() { document.getElementById('sitePreview').src = "index.html"; }
    </script>
</body>
</html>
